<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Dashboard - Core Platform</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Google Font 'Inter' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
      /* Custom scrollbar for aesthetics */
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
      
      /* Use Inter font */
      body { font-family: 'Inter', sans-serif; }

      /* Drag and Drop visual cues */
      .task-card-dragging {
        opacity: 0.5;
        transform: rotate(3deg);
      }
      .drop-zone-active {
        outline: 2px dashed #2563eb; /* blue-600 */
        outline-offset: 4px;
        background: #eff6ff; /* blue-50 */
      }
      .backlog-drop-zone-active {
        background: #f0fdf4; /* green-50 */
        border-color: #22c55e; /* green-500 */
      }
    </style>
</head>
<body class="h-full font-sans text-gray-800">
    <div class="flex h-screen overflow-hidden">
        
        <!-- Mobile Sidebar (hidden by default) -->
        <div id="mobile-sidebar" class="hidden md:hidden" role="dialog" aria-modal="true">
            <div class="fixed inset-0 flex z-40">
                <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-gray-600 bg-opacity-75" aria-hidden="true"></div>
                <div class="relative flex-1 flex flex-col max-w-xs w-full bg-gray-800">
                    <div class="absolute top-0 right-0 -mr-12 pt-2">
                        <button type="button" id="mobile-menu-close" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white">
                            <span class="sr-only">Close sidebar</span>
                            <i data-lucide="x" class="h-6 w-6 text-white"></i>
                        </button>
                    </div>
                    <div class="flex items-center h-16 flex-shrink-0 px-4 bg-gray-900">
                        <span class="text-2xl font-bold text-white tracking-wider">Altura</span><span class="text-2xl font-semibold text-blue-400">Soft</span>
                    </div>
                    <div class="flex-1 h-0 overflow-y-auto">
                        <nav id="mobile-project-menu" class="flex-1 px-2 py-4">
                            <!-- Mobile navigation links will be inserted here by JS -->
                        </nav>
                    </div>
                </div>
                <div class="w-14 flex-shrink-0">
                    <!-- Force sidebar to shrink to fit close icon -->
                </div>
            </div>
        </div>

        <!-- Static Sidebar for desktop -->
        <aside class="hidden md:flex md:flex-shrink-0">
            <div class="flex flex-col w-64">
                <div class="flex items-center h-16 flex-shrink-0 px-4 bg-gray-900">
                    <span class="text-2xl font-bold text-white tracking-wider">Altura</span><span class="text-2xl font-semibold text-blue-400">Soft</span>
                </div>
                <div class="flex-1 flex flex-col overflow-y-auto bg-gray-800">
                    <nav id="desktop-project-menu" class="flex-1 px-2 py-4">
                        <!-- Desktop navigation links will be inserted here by JS -->
                    </nav>
                </div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="flex flex-col flex-1 w-0 overflow-hidden">
            <!-- Header -->
            <header class="relative flex-shrink-0 flex h-16 bg-white shadow-sm border-b border-slate-200">
                <button type="button" id="mobile-menu-button" class="px-4 border-r border-gray-200 text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-500 md:hidden">
                    <span class="sr-only">Open sidebar</span>
                    <i data-lucide="menu" class="h-6 w-6"></i>
                </button>
                <div class="flex-1 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                    <div class="flex-1">
                        <h1 id="main-dashboard-title" class="text-xl font-semibold text-gray-900">Core Platform Team</h1>
                        <p id="today-date" class="text-sm text-gray-500">Loading date...</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button type="button" class="p-1 text-gray-400 hover:text-gray-500 rounded-full bg-white">
                            <span class="sr-only">View notifications</span>
                            <i data-lucide="bell" class="h-6 w-6"></i>
                        </button>
                        <div class="flex items-center">
                            <span class="text-sm font-medium text-gray-700 hidden sm:block">Nina Patel</span>
                            <img class="ml-3 h-8 w-8 rounded-full bg-gray-200" src="https://placehold.co/100x100/60a5fa/ffffff?text=NP" alt="Nina Patel">
                        </div>
                    </div>
                </div>
            </header>

            <!-- Main dashboard content -->
            <main class="flex-1 relative overflow-y-auto focus:outline-none">
                <div class="py-6">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        
                        <!-- Stats Cards -->
                        <div id="stats-cards-container" class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                            <!-- Stats cards will be inserted here by JS -->
                        </div>

                        <!-- Team Layout: Backlog + Team Cards -->
                        <div class="mt-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                            
                            <!-- Column 1: Project Backlog (Draggable Tasks) -->
                            <div class="lg:col-span-1">
                                <div class="flex items-center justify-between">
                                    <h2 class="text-lg leading-6 font-medium text-gray-900">
                                        Project Backlog
                                    </h2>
                                    <button id="add-task-button" class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                        <i data-lucide="plus" class="h-4 w-4 mr-1"></i>
                                        Add Task
                                    </button>
                                </div>
                                <div id="project-backlog-dropzone" class="mt-4 p-4 bg-white rounded-lg shadow-sm border border-slate-200 min-h-[400px]">
                                    <h3 id="project-backlog-title" class="text-sm font-semibold text-gray-700">Backlog for VocaLift (i18n Tool)</h3>
                                    <ul id="project-backlog-list" class="mt-3 space-y-3">
                                        <!-- Draggable task cards will be inserted here by JS -->
                                    </ul>
                                </div>
                            </div>

                            <!-- Column 2: Team Status (Droppable Cards) -->
                            <div class="lg:col-span-2">
                                <h2 class="text-lg leading-6 font-medium text-gray-900">
                                    Team Status & Current Tasks
                                </h2>
                                <ul id="team-cards-container" role="list" class="mt-4 grid grid-cols-1 gap-5 sm:grid-cols-2">
                                    <!-- Team member cards will be inserted here by JS -->
                                </ul>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="task-modal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i data-lucide="plus-circle" class="h-6 w-6 text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Create New Task
                            </h3>
                            <div class="mt-4">
                                <form id="task-form">
                                    <div class="mb-4">
                                        <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                                        <input type="text" id="task-title" name="task-title" required 
                                               class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md px-3 py-2 border"
                                               placeholder="Enter task description">
                                    </div>
                                    <div class="mb-4">
                                        <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                        <select id="task-priority" name="task-priority" 
                                                class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md px-3 py-2 border">
                                            <option value="low">Low</option>
                                            <option value="medium" selected>Medium</option>
                                            <option value="high">High</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label for="task-deadline" class="block text-sm font-medium text-gray-700 mb-1">Deadline</label>
                                        <input type="date" id="task-deadline" name="task-deadline" required
                                               class="shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border-gray-300 rounded-md px-3 py-2 border">
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="create-task-button"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">
                        Create Task
                    </button>
                    <button type="button" id="cancel-task-button"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Store for the Application State
        const state = {
            currentProjectId: 'vocalift',
            teamMembers: [
                { id: 'tm1', name: 'Lucas Werner', role: 'Manager', avatar: 'LW', avatarColor: '60a5fa' },
                { id: 'tm2', name: 'Priya Desai', role: 'Team Lead', avatar: 'PD', avatarColor: 'ec4899' },
                { id: 'tm3', name: 'Hao Nguyen', role: 'Principal Engineer', avatar: 'HN', avatarColor: 'f59e0b' },
                { id: 'tm4', name: 'Marta Kowalski', role: 'Senior Engineer', avatar: 'MK', avatarColor: '8b5cf6' },
                { id: 'tm5', name: 'Diego Silva', role: 'Senior Engineer', avatar: 'DS', avatarColor: '10b981' },
                { id: 'tm6', name: 'Ananya Rao', role: 'Associate Engineer', avatar: 'AR', avatarColor: 'ef4444' },
                { id: 'tm7', name: 'Ethan Brooks', role: 'Associate Engineer', avatar: 'EB', avatarColor: '3b82f6' },
            ],
            projects: {
                'vocalift': {
                    id: 'vocalift',
                    name: 'VocaLift (i18n Tool)',
                    tagColor: 'yellow',
                    tasks: [
                        { id: 'v-t1', title: 'Fix i18n string-loading bug', priority: 'low', deadline: 'Nov 10', assignedTo: 'tm6' },
                        { id: 'v-t2', title: 'Implement new language pack (JP)', priority: 'low', deadline: 'Nov 14', assignedTo: null },
                        { id: 'v-t3', title: 'Audit translation key coverage', priority: 'medium', deadline: 'Nov 20', assignedTo: null },
                    ]
                },
                'authn-mfa': {
                    id: 'authn-mfa',
                    name: 'AuthN-MFA-Rollout',
                    tagColor: 'green',
                    tasks: [
                        { id: 'a-t1', title: 'Coordinating AuthN-MFA testing phase', priority: 'high', deadline: 'Nov 20', assignedTo: 'tm2' },
                        { id: 'a-t2', title: 'Refactoring `identity-service` for MFA hooks', priority: 'high', deadline: 'Nov 18', assignedTo: 'tm4' },
                        { id: 'a-t3', title: 'Adding new unit tests for `config-service` SDK', priority: 'low', deadline: 'Nov 12', assignedTo: 'tm7' },
                        { id: 'a-t4', title: 'Update developer documentation for MFA', priority: 'medium', deadline: 'Nov 25', assignedTo: null },
                    ]
                },
                'billing-v2': {
                    id: 'billing-v2',
                    name: 'Billing-Orchestrator-v2',
                    tagColor: 'blue',
                    tasks: [
                        { id: 'b-t1', title: 'Q4 planning & budget review for Billing-v2', priority: 'high', deadline: 'Nov 15', assignedTo: 'tm1' },
                        { id: 'b-t2', title: 'Designing service-mesh integration', priority: 'medium', deadline: 'Nov 22', assignedTo: 'tm3' },
                        { id: 'b-t3', title: 'Implementing new rate-limiting logic', priority: 'medium', deadline: 'Nov 25', assignedTo: 'tm5' },
                        { id: 'b-t4', title: 'Create new Grafana dashboards for billing', priority: 'low', deadline: 'Nov 28', assignedTo: null },
                        { id: 'b-t5', title: 'Write integration tests for payment provider', priority: 'medium', deadline: 'Dec 02', assignedTo: null },
                    ]
                }
            }
        };

        // Utility Functions
        const getPriorityClasses = (priority) => {
            switch (priority) {
                case 'high': return 'bg-red-100 text-red-800';
                case 'medium': return 'bg-yellow-100 text-yellow-800';
                case 'low': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        };

        const getProjectTagColor = (color) => {
            switch (color) {
                case 'yellow': return 'bg-yellow-100 text-yellow-800';
                case 'green': return 'bg-green-100 text-green-800';
                case 'blue': return 'bg-blue-100 text-blue-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        };

        // --- Rendering Functions ---

        function renderAll() {
            console.log('renderAll called');
            // Re-create icons after rendering
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                lucide.createIcons();
            }
            renderSidebar();
            renderStatsCards();
            renderTeamCards();
            renderProjectBacklog();
            updateMainHeader();
            addDragAndDropListeners();
        }

        function renderSidebar() {
            const projects = Object.values(state.projects);
            const createLink = (project, isMobile = false) => {
                const isActive = project.id === state.currentProjectId;
                const activeClass = isActive ? 'text-white bg-blue-600' : 'text-gray-300 hover:text-white hover:bg-gray-700';
                const textClass = isMobile ? 'text-base' : 'text-sm';
                const iconClass = isMobile ? 'mr-4 h-6 w-6' : 'mr-3 h-5 w-5';
                
                return `
                    <a href="#" 
                       class="group flex items-center px-2 py-2 ${textClass} font-medium rounded-md ${activeClass} project-link" 
                       data-project-id="${project.id}"
                       aria-current="${isActive ? 'page' : 'false'}">
                        <span class="truncate">${project.name}</span>
                    </a>
                `;
            };

            const staticLinks = (isMobile = false) => {
                const textClass = isMobile ? 'text-base' : 'text-sm';
                const iconClass = isMobile ? 'mr-4 h-6 w-6' : 'mr-3 h-5 w-5';
                return `
                    <a href="#" class="dashboard-link group flex items-center px-2 py-2 ${textClass} font-medium text-gray-300 rounded-md hover:text-white hover:bg-gray-700">
                        <i data-lucide="layout-dashboard" class="${iconClass} text-gray-400 group-hover:text-gray-300"></i>
                        Dashboard
                    </a>
                    <a href="#" class="teams-link group flex items-center px-2 py-2 ${textClass} font-medium text-gray-300 rounded-md hover:text-white hover:bg-gray-700">
                        <i data-lucide="users" class="${iconClass} text-gray-400 group-hover:text-gray-300"></i>
                        Teams
                    </a>
                    <div class="mt-6">
                        <h3 class="px-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Current Projects
                        </h3>
                        <div class="mt-2 space-y-1" role="list">
                            ${projects.map(p => createLink(p, isMobile)).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('desktop-project-menu').innerHTML = staticLinks(false);
            document.getElementById('mobile-project-menu').innerHTML = staticLinks(true);
            
            // Add click listeners to project links
            document.querySelectorAll('.project-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.currentProjectId = link.dataset.projectId;
                    renderAll();
                    
                    // Close mobile sidebar if open
                    document.getElementById('mobile-sidebar').classList.add('hidden');
                });
            });

            // Add click listeners to Dashboard links
            document.querySelectorAll('.dashboard-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    alert('Dashboard Overview: This would show an overview of all projects and team performance metrics.');
                });
            });

            // Add click listeners to Teams links
            document.querySelectorAll('.teams-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    showTeamsOverview();
                });
            });
        }

        function renderStatsCards() {
            const container = document.getElementById('stats-cards-container');
            const project = state.projects[state.currentProjectId];
            const tasks = project.tasks || [];
            const tasksInProgress = tasks.filter(t => t.assignedTo).length;
            const tasksInBacklog = tasks.filter(t => !t.assignedTo).length;
            
            const teamMembersOnProject = new Set(tasks.filter(t => t.assignedTo).map(t => t.assignedTo)).size;

            container.innerHTML = `
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-slate-200 cursor-pointer hover:shadow-md transition-shadow" onclick="showTeamMembersDetail()">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0"><div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center"><i data-lucide="users" class="h-6 w-6 text-blue-600"></i></div></div>
                            <div class="ml-4 w-0 flex-1">
                                <dt class="text-sm font-medium text-gray-500 truncate">Team Members on Project</dt>
                                <dd class="text-3xl font-semibold text-gray-900">${teamMembersOnProject}</dd>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-slate-200 cursor-pointer hover:shadow-md transition-shadow" onclick="showAllTasks()">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0"><div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center"><i data-lucide="folder-kanban" class="h-6 w-6 text-green-600"></i></div></div>
                            <div class="ml-4 w-0 flex-1">
                                <dt class="text-sm font-medium text-gray-500 truncate">Total Project Tasks</dt>
                                <dd class="text-3xl font-semibold text-gray-900">${tasks.length}</dd>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-slate-200 cursor-pointer hover:shadow-md transition-shadow" onclick="showInProgressTasks()">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0"><div class="h-10 w-10 rounded-full bg-yellow-100 flex items-center justify-center"><i data-lucide="check-circle" class="h-6 w-6 text-yellow-600"></i></div></div>
                            <div class="ml-4 w-0 flex-1">
                                <dt class="text-sm font-medium text-gray-500 truncate">Tasks In-Progress</dt>
                                <dd class="text-3xl font-semibold text-gray-900">${tasksInProgress}</dd>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white overflow-hidden shadow-sm rounded-lg border border-slate-200 cursor-pointer hover:shadow-md transition-shadow" onclick="showBacklogTasks()">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0"><div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center"><i data-lucide="list" class="h-6 w-6 text-red-600"></i></div></div>
                            <div class="ml-4 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Tasks in Backlog</dt>
                                    <dd class="text-3xl font-semibold text-gray-900">${tasksInBacklog}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTeamCards() {
            const container = document.getElementById('team-cards-container');
            container.innerHTML = ''; // Clear existing cards
            
            state.teamMembers.forEach(member => {
                const assignedTask = state.projects[state.currentProjectId].tasks.find(
                    task => task.assignedTo === member.id
                );
                
                const card = document.createElement('li');
                card.className = 'col-span-1 bg-white rounded-lg shadow-sm border border-slate-200 divide-y divide-slate-200';
                card.dataset.teamId = member.id; // For drop target

                card.innerHTML = `
                    <div class="w-full flex items-center justify-between p-5 space-x-6">
                        <div class="flex-1 truncate">
                            <div class="flex items-center space-x-3">
                                <h3 class="text-gray-900 text-sm font-semibold truncate">${member.name}</h3>
                                <span class="flex-shrink-0 inline-block px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-700 rounded-full">
                                    ${member.role}
                                </span>
                            </div>
                            <p class="mt-1 text-gray-500 text-sm truncate">Core Platform</p>
                        </div>
                        <img class="w-10 h-10 bg-gray-300 rounded-full flex-shrink-0" src="https://placehold.co/100x100/${member.avatarColor}/ffffff?text=${member.avatar}" alt="${member.name}">
                    </div>
                    <div class="p-5 min-h-[160px]">
                        ${assignedTask ? 
                            renderTaskOnCard(assignedTask) : 
                            `<div class="flex items-center justify-center h-full">
                                <p class="text-sm text-gray-400 italic">No task assigned for this project.</p>
                             </div>`
                        }
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function renderTaskOnCard(task) {
            const priorityClass = getPriorityClasses(task.priority);
            return `
                <div class="task-card-assigned" draggable="true" data-task-id="${task.id}" data-project-id="${state.currentProjectId}">
                    <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Current Task</h4>
                    <p class="mt-1 text-sm text-gray-800 font-medium">${task.title}</p>
                    
                    <div class="mt-4 flex justify-between items-start">
                        <div>
                            <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</h4>
                            <span class="mt-1 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityClass}">
                                ${task.priority}
                            </span>
                        </div>
                        <div class="text-right">
                            <h4 class="text-xs font-medium text-gray-500 uppercase tracking-wider flex items-center justify-end">
                                <i data-lucide="calendar" class="mr-1.5 h-3.5 w-3.5 text-gray-400"></i>
                                Deadline
                            </h4>
                            <p class="mt-1 text-sm text-gray-800 font-medium">${task.deadline}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProjectBacklog() {
            const project = state.projects[state.currentProjectId];
            const backlogTasks = project.tasks.filter(task => task.assignedTo === null);
            
            document.getElementById('project-backlog-title').textContent = `Backlog for ${project.name}`;
            const list = document.getElementById('project-backlog-list');
            list.innerHTML = ''; // Clear list
            
            if (backlogTasks.length === 0) {
                list.innerHTML = `<li class="text-sm text-gray-400 italic text-center mt-4">Backlog is empty!</li>`;
                return;
            }

            backlogTasks.forEach(task => {
                const priorityClass = getPriorityClasses(task.priority);
                const taskCard = document.createElement('li');
                taskCard.className = 'p-3 bg-slate-50 rounded-md border border-slate-200 shadow-sm cursor-grab active:cursor-grabbing';
                taskCard.draggable = true;
                taskCard.dataset.taskId = task.id;
                taskCard.dataset.projectId = project.id;
                
                taskCard.innerHTML = `
                    <p class="text-sm font-medium text-gray-800">${task.title}</p>
                    <div class="mt-2 flex justify-between items-center">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${priorityClass}">
                            ${task.priority}
                        </span>
                        <span class="text-xs font-medium text-gray-500 flex items-center">
                            <i data-lucide="calendar" class="mr-1 h-3.5 w-3.5 text-gray-400"></i>
                            ${task.deadline}
                        </span>
                    </div>
                `;
                list.appendChild(taskCard);
            });
        }

        function updateMainHeader() {
            const project = state.projects[state.currentProjectId];
            document.getElementById('main-dashboard-title').textContent = `Core Platform Team - ${project.name}`;
        }
        // --- Interactive Stats Functions ---

        function showTeamMembersDetail() {
            const project = state.projects[state.currentProjectId];
            const activeTasks = project.tasks.filter(t => t.assignedTo);
            const activeMembers = new Set(activeTasks.map(t => t.assignedTo));
            
            const membersList = state.teamMembers
                .filter(m => activeMembers.has(m.id))
                .map(m => `• ${m.name} (${m.role})`)
                .join('\n');
            
            if (membersList) {
                alert(`Team Members Working on ${project.name}:\n\n${membersList}`);
            } else {
                alert(`No team members currently assigned to ${project.name}`);
            }
        }

        function showAllTasks() {
            const project = state.projects[state.currentProjectId];
            const tasks = project.tasks;
            
            if (tasks.length === 0) {
                alert(`No tasks in ${project.name}`);
                return;
            }
            
            const tasksList = tasks.map(t => {
                const assignedMember = t.assignedTo ? state.teamMembers.find(m => m.id === t.assignedTo) : null;
                const status = assignedMember ? `Assigned to ${assignedMember.name}` : 'In Backlog';
                return `• ${t.title}\n  Priority: ${t.priority} | Deadline: ${t.deadline}\n  Status: ${status}`;
            }).join('\n\n');
            
            alert(`All Tasks in ${project.name}:\n\n${tasksList}`);
        }

        function showInProgressTasks() {
            const project = state.projects[state.currentProjectId];
            const inProgressTasks = project.tasks.filter(t => t.assignedTo);
            
            if (inProgressTasks.length === 0) {
                alert(`No tasks currently in progress for ${project.name}`);
                return;
            }
            
            const tasksList = inProgressTasks.map(t => {
                const assignedMember = state.teamMembers.find(m => m.id === t.assignedTo);
                return `• ${t.title}\n  Assigned to: ${assignedMember.name}\n  Priority: ${t.priority} | Deadline: ${t.deadline}`;
            }).join('\n\n');
            
            alert(`Tasks In Progress for ${project.name}:\n\n${tasksList}`);
        }

        function showBacklogTasks() {
            const project = state.projects[state.currentProjectId];
            const backlogTasks = project.tasks.filter(t => !t.assignedTo);
            
            if (backlogTasks.length === 0) {
                alert(`Backlog is empty for ${project.name}!`);
                return;
            }
            
            const tasksList = backlogTasks.map(t => {
                return `• ${t.title}\n  Priority: ${t.priority} | Deadline: ${t.deadline}`;
            }).join('\n\n');
            
            alert(`Backlog Tasks for ${project.name}:\n\n${tasksList}`);
        }

        function showTeamsOverview() {
            let overview = 'TEAM OVERVIEW\n\n';
            
            state.teamMembers.forEach(member => {
                overview += `${member.name} - ${member.role}\n`;
                
                // Count tasks across all projects
                let taskCount = 0;
                let projectsList = [];
                
                Object.values(state.projects).forEach(project => {
                    const memberTasks = project.tasks.filter(t => t.assignedTo === member.id);
                    if (memberTasks.length > 0) {
                        taskCount += memberTasks.length;
                        projectsList.push(`${project.name} (${memberTasks.length})`);
                    }
                });
                
                if (taskCount > 0) {
                    overview += `  Active Tasks: ${taskCount}\n`;
                    overview += `  Projects: ${projectsList.join(', ')}\n`;
                } else {
                    overview += `  No active tasks\n`;
                }
                overview += '\n';
            });
            
            alert(overview);
        }

        // --- Drag and Drop Logic ---

        function addDragAndDropListeners() {
            console.log('Adding drag and drop listeners...');
            
            // 1. Draggable items (backlog and assigned tasks)
            const draggableItems = document.querySelectorAll('[draggable="true"]');
            console.log('Found draggable items:', draggableItems.length);
            
            draggableItems.forEach(item => {
                // Remove existing listeners to prevent duplicates
                item.removeEventListener('dragstart', handleDragStart);
                item.removeEventListener('dragend', handleDragEnd);
                // Add new listeners
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
            
            // 2. Drop targets (team cards)
            const teamCards = document.querySelectorAll('#team-cards-container > li');
            console.log('Found team cards:', teamCards.length);
            
            teamCards.forEach(card => {
                // Remove existing listeners
                card.removeEventListener('dragover', handleDragOver);
                card.removeEventListener('dragleave', handleDragLeave);
                card.removeEventListener('drop', handleDropOnTeamCard);
                // Add new listeners
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDropOnTeamCard);
            });

            // 3. Drop target (backlog)
            const backlogDropzone = document.getElementById('project-backlog-dropzone');
            if (backlogDropzone) {
                backlogDropzone.removeEventListener('dragover', handleDragOverBacklog);
                backlogDropzone.removeEventListener('dragleave', handleDragLeaveBacklog);
                backlogDropzone.removeEventListener('drop', handleDropOnBacklog);
                
                backlogDropzone.addEventListener('dragover', handleDragOverBacklog);
                backlogDropzone.addEventListener('dragleave', handleDragLeaveBacklog);
                backlogDropzone.addEventListener('drop', handleDropOnBacklog);
            }
        }

        function handleDragStart(e) {
            console.log('Drag started:', e.target.dataset.taskId);
            e.target.classList.add('task-card-dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                taskId: e.target.dataset.taskId,
                projectId: e.target.dataset.projectId
            }));
        }

        function handleDragEnd(e) {
            console.log('Drag ended');
            e.target.classList.remove('task-card-dragging');
        }

        function handleDragOver(e) {
            e.preventDefault(); // Necessary to allow drop
            e.dataTransfer.dropEffect = 'move';
            // Find the closest ancestor which is a drop target
            const dropTarget = e.target.closest('#team-cards-container > li');
            if (dropTarget) {
                dropTarget.classList.add('drop-zone-active');
            }
        }

        function handleDragLeave(e) {
            const dropTarget = e.target.closest('#team-cards-container > li');
            if (dropTarget) {
                dropTarget.classList.remove('drop-zone-active');
            }
        }

        function handleDropOnTeamCard(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('Dropped on team card');
            
            const dropTarget = e.target.closest('#team-cards-container > li');
            dropTarget.classList.remove('drop-zone-active');

            const data = e.dataTransfer.getData('text/plain');
            console.log('Drop data:', data);
            
            if (!data) {
                console.error('No data in drop event');
                return;
            }
            
            const { taskId, projectId } = JSON.parse(data);
            const teamId = dropTarget.dataset.teamId;
            
            console.log('Task:', taskId, 'Project:', projectId, 'Team:', teamId);

            // Find the task in state
            const task = state.projects[projectId].tasks.find(t => t.id === taskId);
            if (task) {
                // Check if this team member already has a task for this project
                const existingTask = state.projects[projectId].tasks.find(t => t.assignedTo === teamId);
                if (existingTask) {
                    // Unassign existing task, send it back to backlog
                    existingTask.assignedTo = null;
                }
                
                // Assign new task
                task.assignedTo = teamId;
                console.log('Task assigned successfully');
                renderAll(); // Re-render everything
            } else {
                console.error('Task not found:', taskId);
            }
        }

        function handleDragOverBacklog(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const dropTarget = e.target.closest('#project-backlog-dropzone');
            if (dropTarget) {
                dropTarget.classList.add('backlog-drop-zone-active');
            }
        }

        function handleDragLeaveBacklog(e) {
            const dropTarget = e.target.closest('#project-backlog-dropzone');
            if (dropTarget) {
                dropTarget.classList.remove('backlog-drop-zone-active');
            }
        }

        function handleDropOnBacklog(e) {
            e.preventDefault();
            e.stopPropagation();
            const dropTarget = e.target.closest('#project-backlog-dropzone');
            dropTarget.classList.remove('backlog-drop-zone-active');

            const { taskId, projectId } = JSON.parse(e.dataTransfer.getData('text/plain'));
            
            // Find the task in state
            const task = state.projects[projectId].tasks.find(t => t.id === taskId);
            if (task && task.assignedTo) {
                // Only unassign if it was actually assigned
                task.assignedTo = null;
                renderAll(); // Re-render everything
            }
        }


        // --- Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing dashboard...');
            console.log('State:', state);
            
            // Set Today's Date
            const dateEl = document.getElementById('today-date');
            if (dateEl) {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateEl.textContent = today.toLocaleDateString('en-US', options);
            }

            // Mobile sidebar toggle
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileSidebar = document.getElementById('mobile-sidebar');
            const mobileMenuClose = document.getElementById('mobile-menu-close');
            const mobileSidebarOverlay = document.getElementById('mobile-sidebar-overlay');

            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileSidebar.classList.remove('hidden');
                });
            }
            if (mobileMenuClose) {
                mobileMenuClose.addEventListener('click', () => {
                    mobileSidebar.classList.add('hidden');
                });
            }
            if (mobileSidebarOverlay) {
                mobileSidebarOverlay.addEventListener('click', () => {
                    mobileSidebar.classList.add('hidden');
                });
            }

            // Task Modal handling
            const addTaskButton = document.getElementById('add-task-button');
            const taskModal = document.getElementById('task-modal');
            const cancelTaskButton = document.getElementById('cancel-task-button');
            const createTaskButton = document.getElementById('create-task-button');
            const taskForm = document.getElementById('task-form');

            if (addTaskButton) {
                addTaskButton.addEventListener('click', () => {
                    taskModal.classList.remove('hidden');
                    // Set default deadline to 7 days from now
                    const defaultDeadline = new Date();
                    defaultDeadline.setDate(defaultDeadline.getDate() + 7);
                    document.getElementById('task-deadline').valueAsDate = defaultDeadline;
                });
            }

            if (cancelTaskButton) {
                cancelTaskButton.addEventListener('click', () => {
                    taskModal.classList.add('hidden');
                    taskForm.reset();
                });
            }

            // Close modal when clicking outside
            if (taskModal) {
                taskModal.addEventListener('click', (e) => {
                    if (e.target === taskModal) {
                        taskModal.classList.add('hidden');
                        taskForm.reset();
                    }
                });
            }

            if (createTaskButton) {
                createTaskButton.addEventListener('click', () => {
                    const title = document.getElementById('task-title').value.trim();
                    const priority = document.getElementById('task-priority').value;
                    const deadlineInput = document.getElementById('task-deadline').value;

                    if (!title || !deadlineInput) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    // Format deadline as "Mon DD"
                    const deadlineDate = new Date(deadlineInput);
                    const deadline = deadlineDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                    // Generate unique task ID
                    const projectPrefix = state.currentProjectId.substring(0, 1);
                    const taskCount = state.projects[state.currentProjectId].tasks.length;
                    const newTaskId = `${projectPrefix}-t${taskCount + 1}`;

                    // Create new task
                    const newTask = {
                        id: newTaskId,
                        title: title,
                        priority: priority,
                        deadline: deadline,
                        assignedTo: null
                    };

                    // Add to current project
                    state.projects[state.currentProjectId].tasks.push(newTask);

                    // Close modal and reset form
                    taskModal.classList.add('hidden');
                    taskForm.reset();

                    // Re-render dashboard
                    renderAll();
                });
            }
            
            // Initial Render
            try {
                renderAll();
                console.log('Dashboard rendered successfully');
            } catch (error) {
                console.error('Error rendering dashboard:', error);
            }
        });
    </script>
</body>
</html>